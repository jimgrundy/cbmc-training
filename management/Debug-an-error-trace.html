<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Debugging an error trace - CBMC</title>
        <!-- Custom HTML head -->
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        <link rel="icon" href="../favicon.svg">
        <link rel="shortcut icon" href="../favicon.png">
        <link rel="stylesheet" href="../css/variables.css">
        <link rel="stylesheet" href="../css/general.css">
        <link rel="stylesheet" href="../css/chrome.css">
        <link rel="stylesheet" href="../css/print.css" media="print">
        <!-- Fonts -->
        <link rel="stylesheet" href="../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../fonts/fonts.css">
        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../highlight.css">
        <link rel="stylesheet" href="../tomorrow-night.css">
        <link rel="stylesheet" href="../ayu-highlight.css">

        <!-- Custom theme stylesheets -->
    </head>
    <body>
        <!-- Provide site root to javascript -->
        <script type="text/javascript">
            var path_to_root = "../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded "><a href="../index.html"><strong aria-hidden="true">1.</strong> CBMC quick start</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../installation.html"><strong aria-hidden="true">1.1.</strong> CBMC installation</a></li><li class="chapter-item expanded "><a href="../cbmc/overview/unit-testing.html"><strong aria-hidden="true">1.2.</strong> CBMC as unit testing</a></li><li class="chapter-item expanded "><a href="../cbmc/overview/debugging.html"><strong aria-hidden="true">1.3.</strong> CBMC as debugging</a></li><li class="chapter-item expanded "><a href="../cbmc/overview/proof.html"><strong aria-hidden="true">1.4.</strong> CBMC as proof</a></li></ol></li><li class="chapter-item expanded "><a href="../cbmc/overview/index.html"><strong aria-hidden="true">2.</strong> CBMC proofs</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../cbmc/overview/cbmc.html"><strong aria-hidden="true">2.1.</strong> Running cbmc</a></li><li class="chapter-item expanded "><a href="../cbmc/overview/loop-unwinding.html"><strong aria-hidden="true">2.2.</strong> Loop unwinding</a></li><li class="chapter-item expanded "><a href="../cbmc/overview/checking-properties.html"><strong aria-hidden="true">2.3.</strong> Property checking</a></li><li class="chapter-item expanded "><a href="../cbmc/overview/checking-coverage.html"><strong aria-hidden="true">2.4.</strong> Coverage checking</a></li><li class="chapter-item expanded "><a href="../cbmc/overview/proof-harnesses.html"><strong aria-hidden="true">2.5.</strong> Proof harnesses</a></li><li class="chapter-item expanded "><a href="../cbmc/overview/proof-assumptions.html"><strong aria-hidden="true">2.6.</strong> Proof assumptions</a></li><li class="chapter-item expanded "><a href="../cbmc/overview/goto-programs.html"><strong aria-hidden="true">2.7.</strong> Goto programs</a></li></ol></li><li class="chapter-item expanded "><a href="../starter-kit/overview/index.html"><strong aria-hidden="true">3.</strong> CBMC proof projects</a></li><li class="chapter-item expanded "><div><strong aria-hidden="true">4.</strong> CBMC viewer</div></li><li class="chapter-item expanded "><div><strong aria-hidden="true">5.</strong> Litani</div></li><li class="chapter-item expanded "><div><strong aria-hidden="true">6.</strong> Continuous integration</div></li><li class="chapter-item expanded "><a href="../faq/index.html"><strong aria-hidden="true">7.</strong> Frequently asked questions</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../faq/cbmc.html"><strong aria-hidden="true">7.1.</strong> How does CBMC work?</a></li><li class="chapter-item expanded "><a href="../faq/loop-unwinding.html"><strong aria-hidden="true">7.2.</strong> What is loop unwinding?</a></li><li class="chapter-item expanded "><a href="../faq/memory-model.html"><strong aria-hidden="true">7.3.</strong> How do memory pointers work?</a></li><li class="chapter-item expanded "><div><strong aria-hidden="true">7.4.</strong> How do function pointers work?</div></li><li class="chapter-item expanded "><a href="../faq/malloc.html"><strong aria-hidden="true">7.5.</strong> How does malloc work?</a></li><li class="chapter-item expanded "><div><strong aria-hidden="true">7.6.</strong> How do I write a good stub?</div></li><li class="chapter-item expanded "><a href="../faq/termination.html"><strong aria-hidden="true">7.7.</strong> What do I do when CBMC won't stop?</a></li></ol></li><li class="chapter-item expanded "><a href="../management/index.html"><strong aria-hidden="true">8.</strong> CBMC project management</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../management/Plan-your-proof.html"><strong aria-hidden="true">8.1.</strong> Project planning</a></li><li class="chapter-item expanded "><a href="../management/Write-a-good-proof.html"><strong aria-hidden="true">8.2.</strong> Writing a good proof</a></li><li class="chapter-item expanded "><a href="../management/Debug-an-error-trace.html" class="active"><strong aria-hidden="true">8.3.</strong> Debugging an error trace</a></li><li class="chapter-item expanded "><a href="../management/Code-for-verification.html"><strong aria-hidden="true">8.4.</strong> Coding for verification</a></li><li class="chapter-item expanded "><a href="../management/Code-review-for-proofs.html"><strong aria-hidden="true">8.5.</strong> Proof evaluation</a></li></ol></li><li class="chapter-item expanded "><a href="../projects.html"><strong aria-hidden="true">9.</strong> CBMC projects</a></li><li class="chapter-item expanded "><a href="../resources.html"><strong aria-hidden="true">10.</strong> CBMC resources</a></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light (default)</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">CBMC</h1>

                    <div class="right-buttons">
                        <a href="../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>
                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="debugging-an-error-trace"><a class="header" href="#debugging-an-error-trace">Debugging an error trace</a></h1>
<ul>
<li><a href="#i-see-12-proof-failures-how-do-i-select-which-one-to-debug">I see 12 proof failures. How do I select which one to debug?</a></li>
<li><a href="#how-do-i-debug-a-proof-failure">How do I debug a proof failure?</a>
<ul>
<li><a href="#read-the-trace">Read the trace</a></li>
<li><a href="#add-additional-information-to-the-trace">Add additional information to the trace</a></li>
<li><a href="#delta-debugging">Delta debugging</a></li>
<li><a href="#add-assertions-to-check-your-hypotheses">Add assertions to check your hypotheses.</a></li>
<li><a href="#use-assert0-to-dump-program-state-leading-to-a-checkpoint">Use <code>assert(0)</code> to dump program state leading to a checkpoint</a></li>
<li><a href="#use-assume-to-block-uninteresting-paths">Use <code>assume(...)</code> to block uninteresting paths</a></li>
<li><a href="#consider-the-possibility-it-is-a-fault-in-the-code-itself">Consider the possibility it is a fault in the code itself</a></li>
</ul>
</li>
<li><a href="#how-do-i-improve-proofs-with-low-coverage">How do I improve proofs with low coverage?</a>
<ul>
<li><a href="#fix-any-cbmc-errors">Fix any CBMC errors</a></li>
<li><a href="#check-for-truly-unreachable-code">Check for truly unreachable code.</a></li>
<li><a href="#check-for-over-constrained-inputs">Check for over-constrained inputs</a></li>
</ul>
</li>
<li><a href="#how-can-i-tell-if-my-proof-is-over-constrained">How can I tell if my proof is over-constrained?</a></li>
<li><a href="#what-should-i-do-if-cbmc-crashes">What should I do if CBMC crashes?</a></li>
</ul>
<!-- END doctoc generated TOC please keep comment here to allow auto update -->
<h2 id="i-see-12-proof-failures-how-do-i-select-which-one-to-debug"><a class="header" href="#i-see-12-proof-failures-how-do-i-select-which-one-to-debug">I see 12 proof failures. How do I select which one to debug?</a></h2>
<p>CBMC proof failures seem to come in batches: you run the proof, and see a dozen different errors reported
In many cases, these failures are related: instead of stressing about the number of failures, pick one, debug it, and see if fixing it removes (many of) the others.
Some good heuristics for deciding which failure to investigate:</p>
<ol>
<li><strong>Look for a failure that occurs early on in the proof.</strong>
This will often be the one with the shortest trace [TODO viewer should output this information].
The shorter the trace leading to the issue, the easier it is to debug.</li>
<li><strong>Look for a failure in code you understand.</strong>
Some functions are simpler than others: a failure in a simple function is often easier to analyze that one in a complicated function.
And a failure in a function you understand is easier than one in a function you are not familiar with.</li>
<li><strong>Look for a simple type of failure.</strong>
For example, the trace from a null dereference is often easier to follow than the traces from other uses of bad pointers.
But they're normally exactly the same bug!
Since null dereference bugs normally give the simplest traces, start with them first.
Often, resolving the null dereference also fixes the other related bugs.</li>
</ol>
<h2 id="how-do-i-debug-a-proof-failure"><a class="header" href="#how-do-i-debug-a-proof-failure">How do I debug a proof failure?</a></h2>
<p>There are a number of techniques that have proven useful in debugging proof failures.</p>
<h3 id="read-the-trace"><a class="header" href="#read-the-trace">Read the trace</a></h3>
<p>[TODO link to a guide to viewer]
CBMC viewer generates a step-by-step trace that leads to the assertion violation.
This trace details</p>
<ul>
<li>Every line of code executed</li>
<li>Every function call made</li>
<li>Every time a variable is assigned</li>
</ul>
<p>Essentially, this trace contains everything you would get from attaching a debugger to the program, and single stepping until the violation occurred.
Take a look at the values of the relevant variables right before the assertion violation.
Do they make sense?
If not, figure out where they were assigned.
I often find that <code>Ctrl-F</code> is my friend here: I search for either the variable name, or the value it was assigned, and see where it appears in the trace.</p>
<p>Similarly, look at the set of function calls that led to the error.
Do they make sense?
Are there functions you expect to see there, but don't?
Are there functions you didn't expect to see there, but do?</p>
<h3 id="add-additional-information-to-the-trace"><a class="header" href="#add-additional-information-to-the-trace">Add additional information to the trace</a></h3>
<p>The trace has all the information you need to understand the state of program memory at every point during the execution.
But its not always that easy to reconstruct.
In particular, the trace records the value of a variable when it is written to.
But it doesn't record the value of a variable that is only read, or passed along to another function.</p>
<p>You can solve this by adding &quot;dummy writes&quot; to the program.
For example, let's say you were debugging an error that involved the following function</p>
<pre><code>int foo(struct bar* b, int x) {
    baz(b-&gt;data, x);
}
</code></pre>
<p>Figuring out the value of <code>b-&gt;data</code> and <code>x</code> are possible given a complete trace, but its difficult.
Any it might harder to figure out the value of <code>b-&gt;size</code>.
Instead, annotate the code to track those values:</p>
<pre><code>int foo(struct bar* b, int x) {
        struct bar debug_foo_b = *b;
        int debug_foo_x = x;
    baz(b-&gt;data, x);
}
</code></pre>
<p>the trace will now contain an assignment to <code>debug_foo_b</code>, which will let you see what values each member of the struct had.</p>
<h3 id="delta-debugging"><a class="header" href="#delta-debugging">Delta debugging</a></h3>
<p><a href="http://web2.cs.columbia.edu/%7Ejunfeng/09fa-e6998/papers/delta-debug.pdf">Delta debugging</a> is a powerful technique for localizing faults and creating minimal reproducing test-cases.
Essentially, you modify the program in some way, typically either by removing (commenting out) or modifying code.
You then rerun the verification tool, and see if the results changed.
The goal is to either:</p>
<ol>
<li>produce a small program which still displays the bug or</li>
<li>produce a small change between two programs, one of which has the bug, and the other doesn't.</li>
</ol>
<p>In case 1, you now have a small program which is hopefully easy to understand;
In case 2, you have a small change which induces the bug, and hopefully leads you toward the root cause.</p>
<h3 id="add-assertions-to-check-your-hypotheses"><a class="header" href="#add-assertions-to-check-your-hypotheses">Add assertions to check your hypotheses.</a></h3>
<p>For example, consider the case of a null pointer dereference of a pointer <code>p</code>.
It is important to distinguish the case where the pointer <em>must</em> be null, vs the case where it <em>may</em> be null, vs the case where it <em>is never</em> null.
You can test for these cases by adding <code>assert(p)</code> to the function.
If the can be null, the assertion will trigger.
If it cannot be null, the assertion will succeed.</p>
<p>Now, check <code>assert(!p)</code> instead.
If can be non-null, this assertion will fail.
If it can only be null, this assertion will succeed.</p>
<p>You now know which one of the three cases is true.
And you can use the trace to see why it can be null/non-null.</p>
<p>You can do similar things to determine why a branch is reachable, or unreachable.</p>
<h3 id="use-assert0-to-dump-program-state-leading-to-a-checkpoint"><a class="header" href="#use-assert0-to-dump-program-state-leading-to-a-checkpoint">Use <code>assert(0)</code> to dump program state leading to a checkpoint</a></h3>
<p>Sometimes, you want to know how/whether a particular line of code is reachable.
One easy way to learn that is to put <code>assert(0)</code> right before the line.
CBMC will detect the assertion violation, and give a trace explaining how it reached there, and with what values.
If the assertion passes without error, you know that the line is unreachable given the current proof harness.</p>
<h3 id="use-assume-to-block-uninteresting-paths"><a class="header" href="#use-assume-to-block-uninteresting-paths">Use <code>assume(...)</code> to block uninteresting paths</a></h3>
<p>There are often many possible execution paths that reach a given line of code / assertion.
Some of these may reflect cases you are trying to understand, while others do not help with your current debugging plan.
Left to its own devices, CBMC will non-deterministically choose one of those traces, which may not be the one you want.
You can guide CBMC to the trace you want by sprinkling <code>__CPROVER_assume()</code> statements within the code.
For example, you might <code>__CPROVER_assume()</code> that a function fails with an error code, to test whether the calling function handles that error code correctly.
Or you might <code>__CPROVER_assume()</code> that a given variable is null, to simplify you search for the root cause of a null dereference.</p>
<h3 id="consider-the-possibility-it-is-a-fault-in-the-code-being-verified"><a class="header" href="#consider-the-possibility-it-is-a-fault-in-the-code-being-verified">Consider the possibility it is a fault in the code being verified</a></h3>
<p>In many cases, the error detected by CBMC represents a true issue within the code being verified.
This is particularly common in the case of functions which fail to validate their inputs.
In this case, the fix is either to validate the inputs, and return an error if given invalid inputs, or to document the requirements on the inputs, and state that actions on illegal inputs are undefined behavior.
Which solution you choose depends on the risk profile of the code.</p>
<p>It is also common that code being verified has integer-overflows and other errors that only occur in unusual circumstances.
In these cases, the solution is to either guarantee that inputs are sufficiently small to prevent these issues, or to use overflow-safe built-ins, such as gcc's <code>__builtin_mul_overflow</code> (documented <a href="https://gcc.gnu.org/onlinedocs/gcc/Integer-Overflow-Builtins.html">here</a>).</p>
<h2 id="how-do-i-improve-proofs-with-low-coverage"><a class="header" href="#how-do-i-improve-proofs-with-low-coverage">How do I improve proofs with low coverage?</a></h2>
<h3 id="fix-any-error-detected-by-cbmc"><a class="header" href="#fix-any-error-detected-by-cbmc">Fix any error detected by CBMC</a></h3>
<p>Make sure that there are no missing function definitions, or property violations.
Both of these errors can affect coverage calculations.</p>
<h3 id="check-for-truly-unreachable-code"><a class="header" href="#check-for-truly-unreachable-code">Check for truly unreachable code.</a></h3>
<p>In some cases, code may be truly unreachable - for example, redundant defensive checks.
Or this may be code which is reachable using particular inputs, but not in the context of your proof.
For example:</p>
<pre><code>int size_from_enum(type_enum t) {
        switch (t) {
        case BAR: return 1;
        case BAZ: return 2;
        ...
}

int function_being_tested() {
        return size_from_enum(BAZ);
}
</code></pre>
<p>In this case, most of the lines in <code>size_from_enum</code> will appear to be unreachable, even though the proof has full coverage of all truly reachable paths.</p>
<h3 id="check-for-over-constrained-inputs"><a class="header" href="#check-for-over-constrained-inputs">Check for over-constrained inputs</a></h3>
<p>Consider the case where one side of a branch is not reached, or where execution does not continue past an assumption.
In this case, it is possible that the inputs have been over-constrained in the proof harness. You can try to relax some of the <code>__CPROVER_assume()</code> statements.</p>
<h2 id="how-can-i-tell-if-my-proof-is-over-constrained"><a class="header" href="#how-can-i-tell-if-my-proof-is-over-constrained">How can I tell if my proof is over-constrained?</a></h2>
<p>This will normally appear in coverage - over-constrained proofs will usually have unreachable portions of code.
You can also add a &quot;smoke test&quot;, but adding assertions that you expect to fail to the code (which can be as simple as <code>assert(0)</code>).
If these assertions do not fail, then something is wrong with your proof.</p>
<h2 id="what-should-i-do-if-cbmc-crashes"><a class="header" href="#what-should-i-do-if-cbmc-crashes">What should I do if CBMC crashes?</a></h2>
<ol>
<li>Make a new branch in your project, containing the exact code that caused cbmc to crash.
We recommend giving it a name like <code>cbmc-crashing-bug-1</code>.</li>
<li>Push it to a public github repo (if possible)</li>
<li>Post a bug report <a href="https://github.com/diffblue/cbmc/issues/new">here</a>, linking to the branch that you pushed containing the bug.</li>
<li>Post a bug report on this repo, linking to the bug that you posted on the main CBMC repo.</li>
</ol>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../management/Write-a-good-proof.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>
                            <a rel="next" href="../management/Code-for-verification.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>
                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../management/Write-a-good-proof.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>
                    <a rel="next" href="../management/Code-for-verification.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>

        <script type="text/javascript">
            window.playground_copyable = true;
        </script>
        <script src="../elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../searcher.js" type="text/javascript" charset="utf-8"></script>
        <script src="../clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="../book.js" type="text/javascript" charset="utf-8"></script>

        <!-- Custom JS scripts -->
    </body>
</html>
