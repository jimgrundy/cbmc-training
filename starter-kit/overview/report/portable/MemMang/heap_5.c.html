
<html>
<head>
<title>portable/MemMang/heap_5.c</title>
<link rel="stylesheet" type="text/css" href="../../viewer.css">
</head>

<body>
<div class="code">
<div id="1" class="line none">    1 /*</div><div id="2" class="line none">    2  * FreeRTOS Kernel &lt;DEVELOPMENT BRANCH&gt;</div><div id="3" class="line none">    3  * Copyright (C) 2021 Amazon.com, Inc. or its affiliates.  All Rights Reserved.</div><div id="4" class="line none">    4  *</div><div id="5" class="line none">    5  * SPDX-License-Identifier: MIT</div><div id="6" class="line none">    6  *</div><div id="7" class="line none">    7  * Permission is hereby granted, free of charge, to any person obtaining a copy of</div><div id="8" class="line none">    8  * this software and associated documentation files (the "Software"), to deal in</div><div id="9" class="line none">    9  * the Software without restriction, including without limitation the rights to</div><div id="10" class="line none">   10  * use, copy, modify, merge, publish, distribute, sublicense, and/or sell copies of</div><div id="11" class="line none">   11  * the Software, and to permit persons to whom the Software is furnished to do so,</div><div id="12" class="line none">   12  * subject to the following conditions:</div><div id="13" class="line none">   13  *</div><div id="14" class="line none">   14  * The above copyright notice and this permission notice shall be included in all</div><div id="15" class="line none">   15  * copies or substantial portions of the Software.</div><div id="16" class="line none">   16  *</div><div id="17" class="line none">   17  * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR</div><div id="18" class="line none">   18  * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY, FITNESS</div><div id="19" class="line none">   19  * FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR</div><div id="20" class="line none">   20  * COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER</div><div id="21" class="line none">   21  * IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN</div><div id="22" class="line none">   22  * CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.</div><div id="23" class="line none">   23  *</div><div id="24" class="line none">   24  * https://www.FreeRTOS.org</div><div id="25" class="line none">   25  * https://github.com/FreeRTOS</div><div id="26" class="line none">   26  *</div><div id="27" class="line none">   27  */</div><div id="28" class="line none">   28 </div><div id="29" class="line none">   29 /*</div><div id="30" class="line none">   30  * A sample implementation of pvPortMalloc() that allows the heap to be defined</div><div id="31" class="line none">   31  * across multiple non-contigous blocks and combines (coalescences) adjacent</div><div id="32" class="line none">   32  * memory blocks as they are freed.</div><div id="33" class="line none">   33  *</div><div id="34" class="line none">   34  * See heap_1.c, heap_2.c, heap_3.c and heap_4.c for alternative</div><div id="35" class="line none">   35  * implementations, and the memory management pages of https://www.FreeRTOS.org</div><div id="36" class="line none">   36  * for more information.</div><div id="37" class="line none">   37  *</div><div id="38" class="line none">   38  * Usage notes:</div><div id="39" class="line none">   39  *</div><div id="40" class="line none">   40  * vPortDefineHeapRegions() ***must*** be called before pvPortMalloc().</div><div id="41" class="line none">   41  * pvPortMalloc() will be called if any task objects (tasks, queues, event</div><div id="42" class="line none">   42  * groups, etc.) are created, therefore vPortDefineHeapRegions() ***must*** be</div><div id="43" class="line none">   43  * called before any other objects are defined.</div><div id="44" class="line none">   44  *</div><div id="45" class="line none">   45  * vPortDefineHeapRegions() takes a single parameter.  The parameter is an array</div><div id="46" class="line none">   46  * of HeapRegion_t structures.  HeapRegion_t is defined in portable.h as</div><div id="47" class="line none">   47  *</div><div id="48" class="line none">   48  * typedef struct HeapRegion</div><div id="49" class="line none">   49  * {</div><div id="50" class="line none">   50  *  uint8_t *pucStartAddress; &lt;&lt; Start address of a block of memory that will be part of the heap.</div><div id="51" class="line none">   51  *  size_t xSizeInBytes;      &lt;&lt; Size of the block of memory.</div><div id="52" class="line none">   52  * } HeapRegion_t;</div><div id="53" class="line none">   53  *</div><div id="54" class="line none">   54  * The array is terminated using a NULL zero sized region definition, and the</div><div id="55" class="line none">   55  * memory regions defined in the array ***must*** appear in address order from</div><div id="56" class="line none">   56  * low address to high address.  So the following is a valid example of how</div><div id="57" class="line none">   57  * to use the function.</div><div id="58" class="line none">   58  *</div><div id="59" class="line none">   59  * HeapRegion_t xHeapRegions[] =</div><div id="60" class="line none">   60  * {</div><div id="61" class="line none">   61  *  { ( uint8_t * ) 0x80000000UL, 0x10000 }, &lt;&lt; Defines a block of 0x10000 bytes starting at address 0x80000000</div><div id="62" class="line none">   62  *  { ( uint8_t * ) 0x90000000UL, 0xa0000 }, &lt;&lt; Defines a block of 0xa0000 bytes starting at address of 0x90000000</div><div id="63" class="line none">   63  *  { NULL, 0 }                &lt;&lt; Terminates the array.</div><div id="64" class="line none">   64  * };</div><div id="65" class="line none">   65  *</div><div id="66" class="line none">   66  * vPortDefineHeapRegions( xHeapRegions ); &lt;&lt; Pass the array into vPortDefineHeapRegions().</div><div id="67" class="line none">   67  *</div><div id="68" class="line none">   68  * Note 0x80000000 is the lower address so appears in the array first.</div><div id="69" class="line none">   69  *</div><div id="70" class="line none">   70  */</div><div id="71" class="line none">   71 #include &lt;stdlib.h&gt;</div><div id="72" class="line none">   72 #include &lt;string.h&gt;</div><div id="73" class="line none">   73 </div><div id="74" class="line none">   74 /* Defining MPU_WRAPPERS_INCLUDED_FROM_API_FILE prevents task.h from redefining</div><div id="75" class="line none">   75  * all the API functions to use the MPU wrappers.  That should only be done when</div><div id="76" class="line none">   76  * task.h is included from an application file. */</div><div id="77" class="line none">   77 #define <a href="heap_5.c.html#77">MPU_WRAPPERS_INCLUDED_FROM_API_FILE</a></div><div id="78" class="line none">   78 </div><div id="79" class="line none">   79 #include "FreeRTOS.h"</div><div id="80" class="line none">   80 #include "task.h"</div><div id="81" class="line none">   81 </div><div id="82" class="line none">   82 #undef <a href="heap_5.c.html#77">MPU_WRAPPERS_INCLUDED_FROM_API_FILE</a></div><div id="83" class="line none">   83 </div><div id="84" class="line none">   84 #if ( configSUPPORT_DYNAMIC_ALLOCATION == 0 )</div><div id="85" class="line none">   85     #error This file must not be used if configSUPPORT_DYNAMIC_ALLOCATION is 0</div><div id="86" class="line none">   86 #endif</div><div id="87" class="line none">   87 </div><div id="88" class="line none">   88 #ifndef <a href="heap_5.c.html#89">configHEAP_CLEAR_MEMORY_ON_FREE</a></div><div id="89" class="line none">   89     #define <a href="heap_5.c.html#89">configHEAP_CLEAR_MEMORY_ON_FREE</a>    0</div><div id="90" class="line none">   90 #endif</div><div id="91" class="line none">   91 </div><div id="92" class="line none">   92 /* Block sizes must not get too small. */</div><div id="93" class="line none">   93 #define <a href="heap_5.c.html#93">heapMINIMUM_BLOCK_SIZE</a>    ( ( size_t ) ( <a href="heap_5.c.html#141">xHeapStructSize</a> &lt;&lt; 1 ) )</div><div id="94" class="line none">   94 </div><div id="95" class="line none">   95 /* Assumes 8bit bytes! */</div><div id="96" class="line none">   96 #define <a href="heap_5.c.html#96">heapBITS_PER_BYTE</a>         ( ( size_t ) 8 )</div><div id="97" class="line none">   97 </div><div id="98" class="line none">   98 /* Max value that fits in a size_t type. */</div><div id="99" class="line none">   99 #define <a href="heap_5.c.html#99">heapSIZE_MAX</a>              ( ~( ( size_t ) 0 ) )</div><div id="100" class="line none">  100 </div><div id="101" class="line none">  101 /* Check if multiplying a and b will result in overflow. */</div><div id="102" class="line none">  102 #define <a href="heap_5.c.html#102">heapMULTIPLY_WILL_OVERFLOW</a>( a, b )    ( ( ( a ) &gt; 0 ) &amp;&amp; ( ( b ) &gt; ( <a href="heap_5.c.html#99">heapSIZE_MAX</a> / ( a ) ) ) )</div><div id="103" class="line none">  103 </div><div id="104" class="line none">  104 /* Check if adding a and b will result in overflow. */</div><div id="105" class="line none">  105 #define <a href="heap_5.c.html#105">heapADD_WILL_OVERFLOW</a>( a, b )         ( ( a ) &gt; ( <a href="heap_5.c.html#99">heapSIZE_MAX</a> - ( b ) ) )</div><div id="106" class="line none">  106 </div><div id="107" class="line none">  107 /* MSB of the xBlockSize member of an BlockLink_t structure is used to track</div><div id="108" class="line none">  108  * the allocation status of a block.  When MSB of the xBlockSize member of</div><div id="109" class="line none">  109  * an BlockLink_t structure is set then the block belongs to the application.</div><div id="110" class="line none">  110  * When the bit is free the block is still part of the free heap space. */</div><div id="111" class="line none">  111 #define <a href="heap_5.c.html#111">heapBLOCK_ALLOCATED_BITMASK</a>    ( ( ( size_t ) 1 ) &lt;&lt; ( ( sizeof( size_t ) * <a href="heap_5.c.html#96">heapBITS_PER_BYTE</a> ) - 1 ) )</div><div id="112" class="line none">  112 #define <a href="heap_5.c.html#112">heapBLOCK_SIZE_IS_VALID</a>( <a href="heap_5.c.html#124">xBlockSize</a> )    ( ( ( <a href="heap_5.c.html#124">xBlockSize</a> ) &amp; <a href="heap_5.c.html#111">heapBLOCK_ALLOCATED_BITMASK</a> ) == 0 )</div><div id="113" class="line none">  113 #define <a href="heap_5.c.html#113">heapBLOCK_IS_ALLOCATED</a>( pxBlock )        ( ( ( pxBlock-&gt;<a href="heap_5.c.html#124">xBlockSize</a> ) &amp; <a href="heap_5.c.html#111">heapBLOCK_ALLOCATED_BITMASK</a> ) != 0 )</div><div id="114" class="line none">  114 #define <a href="heap_5.c.html#114">heapALLOCATE_BLOCK</a>( pxBlock )            ( ( pxBlock-&gt;<a href="heap_5.c.html#124">xBlockSize</a> ) |= <a href="heap_5.c.html#111">heapBLOCK_ALLOCATED_BITMASK</a> )</div><div id="115" class="line none">  115 #define <a href="heap_5.c.html#115">heapFREE_BLOCK</a>( pxBlock )                ( ( pxBlock-&gt;<a href="heap_5.c.html#124">xBlockSize</a> ) &amp;= ~<a href="heap_5.c.html#111">heapBLOCK_ALLOCATED_BITMASK</a> )</div><div id="116" class="line none">  116 </div><div id="117" class="line none">  117 /*-----------------------------------------------------------*/</div><div id="118" class="line none">  118 </div><div id="119" class="line none">  119 /* Define the linked list structure.  This is used to link free blocks in order</div><div id="120" class="line none">  120  * of their memory address. */</div><div id="121" class="line none">  121 typedef struct <a href="heap_5.c.html#121">A_BLOCK_LINK</a></div><div id="122" class="line none">  122 {</div><div id="123" class="line none">  123     struct <a href="heap_5.c.html#121">A_BLOCK_LINK</a> * <a href="heap_5.c.html#123">pxNextFreeBlock</a>; /*&lt;&lt; The next free block in the list. */</div><div id="124" class="line none">  124     size_t <a href="heap_5.c.html#124">xBlockSize</a>;                     /*&lt;&lt; The size of the free block. */</div><div id="125" class="line none">  125 } <a href="heap_5.c.html#125">BlockLink_t</a>;</div><div id="126" class="line none">  126 </div><div id="127" class="line none">  127 /*-----------------------------------------------------------*/</div><div id="128" class="line none">  128 </div><div id="129" class="line none">  129 /*</div><div id="130" class="line none">  130  * Inserts a block of memory that is being freed into the correct position in</div><div id="131" class="line none">  131  * the list of free memory blocks.  The block being freed will be merged with</div><div id="132" class="line none">  132  * the block in front it and/or the block behind it if the memory blocks are</div><div id="133" class="line none">  133  * adjacent to each other.</div><div id="134" class="line none">  134  */</div><div id="135" class="line none">  135 static void <a href="heap_5.c.html#379">prvInsertBlockIntoFreeList</a>( <a href="heap_5.c.html#125">BlockLink_t</a> * pxBlockToInsert );</div><div id="136" class="line none">  136 </div><div id="137" class="line none">  137 /*-----------------------------------------------------------*/</div><div id="138" class="line none">  138 </div><div id="139" class="line none">  139 /* The size of the structure placed at the beginning of each allocated memory</div><div id="140" class="line none">  140  * block must by correctly byte aligned. */</div><div id="141" class="line none">  141 static const size_t <a href="heap_5.c.html#141">xHeapStructSize</a> = ( sizeof( <a href="heap_5.c.html#125">BlockLink_t</a> ) + ( ( size_t ) ( <a href="../ThirdParty/GCC/Posix/portmacro.h.html#75">portBYTE_ALIGNMENT</a> - 1 ) ) ) &amp; ~( ( size_t ) <a href="../../include/portable.h.html#57">portBYTE_ALIGNMENT_MASK</a> );</div><div id="142" class="line none">  142 </div><div id="143" class="line none">  143 /* Create a couple of list links to mark the start and end of the list. */</div><div id="144" class="line none">  144 static <a href="heap_5.c.html#125">BlockLink_t</a> <a href="heap_5.c.html#144">xStart</a>, * <a href="heap_5.c.html#144">pxEnd</a> = NULL;</div><div id="145" class="line none">  145 </div><div id="146" class="line none">  146 /* Keeps track of the number of calls to allocate and free memory as well as the</div><div id="147" class="line none">  147  * number of free bytes remaining, but says nothing about fragmentation. */</div><div id="148" class="line none">  148 static size_t <a href="heap_5.c.html#148">xFreeBytesRemaining</a> = 0U;</div><div id="149" class="line none">  149 static size_t <a href="heap_5.c.html#149">xMinimumEverFreeBytesRemaining</a> = 0U;</div><div id="150" class="line none">  150 static size_t <a href="heap_5.c.html#150">xNumberOfSuccessfulAllocations</a> = 0;</div><div id="151" class="line none">  151 static size_t <a href="heap_5.c.html#151">xNumberOfSuccessfulFrees</a> = 0;</div><div id="152" class="line none">  152 </div><div id="153" class="line none">  153 /*-----------------------------------------------------------*/</div><div id="154" class="line none">  154 </div><div id="155" class="line none">  155 void * <a href="heap_5.c.html#155">pvPortMalloc</a>( size_t xWantedSize )</div><div id="156" class="line none">  156 {</div><div id="157" class="line hit">  157     <a href="heap_5.c.html#125">BlockLink_t</a> * pxBlock, * pxPreviousBlock, * pxNewBlockLink;</div><div id="158" class="line hit">  158     void * pvReturn = NULL;</div><div id="159" class="line hit">  159     size_t xAdditionalRequiredSize;</div><div id="160" class="line none">  160 </div><div id="161" class="line none">  161     /* The heap must be initialised before the first call to</div><div id="162" class="line none">  162      * prvPortMalloc(). */</div><div id="163" class="line none">  163     configASSERT( <a href="heap_5.c.html#144">pxEnd</a> );</div><div id="164" class="line none">  164 </div><div id="165" class="line hit">  165     <a href="../../include/task.h.html#1370">vTaskSuspendAll</a>();</div><div id="166" class="line none">  166     {</div><div id="167" class="line hit">  167         if( xWantedSize &gt; 0 )</div><div id="168" class="line none">  168         {</div><div id="169" class="line none">  169             /* The wanted size must be increased so it can contain a BlockLink_t</div><div id="170" class="line none">  170              * structure in addition to the requested amount of bytes. Some</div><div id="171" class="line none">  171              * additional increment may also be needed for alignment. */</div><div id="172" class="line hit">  172             xAdditionalRequiredSize = <a href="heap_5.c.html#141">xHeapStructSize</a> + <a href="../ThirdParty/GCC/Posix/portmacro.h.html#75">portBYTE_ALIGNMENT</a> - ( xWantedSize &amp; <a href="../../include/portable.h.html#57">portBYTE_ALIGNMENT_MASK</a> );</div><div id="173" class="line none">  173 </div><div id="174" class="line hit">  174             if( <a href="heap_5.c.html#105">heapADD_WILL_OVERFLOW</a>( xWantedSize, xAdditionalRequiredSize ) == 0 )</div><div id="175" class="line none">  175             {</div><div id="176" class="line hit">  176                 xWantedSize += xAdditionalRequiredSize;</div><div id="177" class="line none">  177             }</div><div id="178" class="line none">  178             else</div><div id="179" class="line none">  179             {</div><div id="180" class="line hit">  180                 xWantedSize = 0;</div><div id="181" class="line none">  181             }</div><div id="182" class="line none">  182         }</div><div id="183" class="line none">  183         else</div><div id="184" class="line none">  184         {</div><div id="185" class="line none">  185             mtCOVERAGE_TEST_MARKER();</div><div id="186" class="line none">  186         }</div><div id="187" class="line none">  187 </div><div id="188" class="line none">  188         /* Check the block size we are trying to allocate is not so large that the</div><div id="189" class="line none">  189          * top bit is set.  The top bit of the block size member of the BlockLink_t</div><div id="190" class="line none">  190          * structure is used to determine who owns the block - the application or</div><div id="191" class="line none">  191          * the kernel, so it must be free. */</div><div id="192" class="line hit">  192         if( <a href="heap_5.c.html#112">heapBLOCK_SIZE_IS_VALID</a>( xWantedSize ) != 0 )</div><div id="193" class="line none">  193         {</div><div id="194" class="line hit">  194             if( ( xWantedSize &gt; 0 ) &amp;&amp; ( xWantedSize &lt;= <a href="heap_5.c.html#148">xFreeBytesRemaining</a> ) )</div><div id="195" class="line none">  195             {</div><div id="196" class="line none">  196                 /* Traverse the list from the start (lowest address) block until</div><div id="197" class="line none">  197                  * one of adequate size is found. */</div><div id="198" class="line missed">  198                 pxPreviousBlock = &amp;<a href="heap_5.c.html#144">xStart</a>;</div><div id="199" class="line missed">  199                 pxBlock = <a href="heap_5.c.html#144">xStart</a>.<a href="heap_5.c.html#123">pxNextFreeBlock</a>;</div><div id="200" class="line none">  200 </div><div id="201" class="line missed">  201                 while( ( pxBlock-&gt;<a href="heap_5.c.html#124">xBlockSize</a> &lt; xWantedSize ) &amp;&amp; ( pxBlock-&gt;<a href="heap_5.c.html#123">pxNextFreeBlock</a> != NULL ) )</div><div id="202" class="line none">  202                 {</div><div id="203" class="line missed">  203                     pxPreviousBlock = pxBlock;</div><div id="204" class="line missed">  204                     pxBlock = pxBlock-&gt;<a href="heap_5.c.html#123">pxNextFreeBlock</a>;</div><div id="205" class="line none">  205                 }</div><div id="206" class="line none">  206 </div><div id="207" class="line none">  207                 /* If the end marker was reached then a block of adequate size</div><div id="208" class="line none">  208                  * was not found. */</div><div id="209" class="line missed">  209                 if( pxBlock != <a href="heap_5.c.html#144">pxEnd</a> )</div><div id="210" class="line none">  210                 {</div><div id="211" class="line none">  211                     /* Return the memory space pointed to - jumping over the</div><div id="212" class="line none">  212                      * BlockLink_t structure at its start. */</div><div id="213" class="line missed">  213                     pvReturn = ( void * ) ( ( ( uint8_t * ) pxPreviousBlock-&gt;<a href="heap_5.c.html#123">pxNextFreeBlock</a> ) + <a href="heap_5.c.html#141">xHeapStructSize</a> );</div><div id="214" class="line none">  214 </div><div id="215" class="line none">  215                     /* This block is being returned for use so must be taken out</div><div id="216" class="line none">  216                      * of the list of free blocks. */</div><div id="217" class="line missed">  217                     pxPreviousBlock-&gt;<a href="heap_5.c.html#123">pxNextFreeBlock</a> = pxBlock-&gt;<a href="heap_5.c.html#123">pxNextFreeBlock</a>;</div><div id="218" class="line none">  218 </div><div id="219" class="line none">  219                     /* If the block is larger than required it can be split into</div><div id="220" class="line none">  220                      * two. */</div><div id="221" class="line missed">  221                     if( ( pxBlock-&gt;<a href="heap_5.c.html#124">xBlockSize</a> - xWantedSize ) &gt; <a href="heap_5.c.html#93">heapMINIMUM_BLOCK_SIZE</a> )</div><div id="222" class="line none">  222                     {</div><div id="223" class="line none">  223                         /* This block is to be split into two.  Create a new</div><div id="224" class="line none">  224                          * block following the number of bytes requested. The void</div><div id="225" class="line none">  225                          * cast is used to prevent byte alignment warnings from the</div><div id="226" class="line none">  226                          * compiler. */</div><div id="227" class="line missed">  227                         pxNewBlockLink = ( void * ) ( ( ( uint8_t * ) pxBlock ) + xWantedSize );</div><div id="228" class="line none">  228 </div><div id="229" class="line none">  229                         /* Calculate the sizes of two blocks split from the</div><div id="230" class="line none">  230                          * single block. */</div><div id="231" class="line missed">  231                         pxNewBlockLink-&gt;<a href="heap_5.c.html#124">xBlockSize</a> = pxBlock-&gt;<a href="heap_5.c.html#124">xBlockSize</a> - xWantedSize;</div><div id="232" class="line missed">  232                         pxBlock-&gt;<a href="heap_5.c.html#124">xBlockSize</a> = xWantedSize;</div><div id="233" class="line none">  233 </div><div id="234" class="line none">  234                         /* Insert the new block into the list of free blocks. */</div><div id="235" class="line missed">  235                         <a href="heap_5.c.html#379">prvInsertBlockIntoFreeList</a>( ( pxNewBlockLink ) );</div><div id="236" class="line none">  236                     }</div><div id="237" class="line none">  237                     else</div><div id="238" class="line none">  238                     {</div><div id="239" class="line none">  239                         mtCOVERAGE_TEST_MARKER();</div><div id="240" class="line none">  240                     }</div><div id="241" class="line none">  241 </div><div id="242" class="line missed">  242                     <a href="heap_5.c.html#148">xFreeBytesRemaining</a> -= pxBlock-&gt;<a href="heap_5.c.html#124">xBlockSize</a>;</div><div id="243" class="line none">  243 </div><div id="244" class="line missed">  244                     if( <a href="heap_5.c.html#148">xFreeBytesRemaining</a> &lt; <a href="heap_5.c.html#149">xMinimumEverFreeBytesRemaining</a> )</div><div id="245" class="line none">  245                     {</div><div id="246" class="line missed">  246                         <a href="heap_5.c.html#149">xMinimumEverFreeBytesRemaining</a> = <a href="heap_5.c.html#148">xFreeBytesRemaining</a>;</div><div id="247" class="line none">  247                     }</div><div id="248" class="line none">  248                     else</div><div id="249" class="line none">  249                     {</div><div id="250" class="line none">  250                         mtCOVERAGE_TEST_MARKER();</div><div id="251" class="line none">  251                     }</div><div id="252" class="line none">  252 </div><div id="253" class="line none">  253                     /* The block is being returned - it is allocated and owned</div><div id="254" class="line none">  254                      * by the application and has no "next" block. */</div><div id="255" class="line missed">  255                     <a href="heap_5.c.html#114">heapALLOCATE_BLOCK</a>( pxBlock );</div><div id="256" class="line missed">  256                     pxBlock-&gt;<a href="heap_5.c.html#123">pxNextFreeBlock</a> = NULL;</div><div id="257" class="line missed">  257                     <a href="heap_5.c.html#150">xNumberOfSuccessfulAllocations</a>++;</div><div id="258" class="line none">  258                 }</div><div id="259" class="line none">  259                 else</div><div id="260" class="line none">  260                 {</div><div id="261" class="line none">  261                     mtCOVERAGE_TEST_MARKER();</div><div id="262" class="line none">  262                 }</div><div id="263" class="line none">  263             }</div><div id="264" class="line none">  264             else</div><div id="265" class="line none">  265             {</div><div id="266" class="line none">  266                 mtCOVERAGE_TEST_MARKER();</div><div id="267" class="line none">  267             }</div><div id="268" class="line none">  268         }</div><div id="269" class="line none">  269         else</div><div id="270" class="line none">  270         {</div><div id="271" class="line none">  271             mtCOVERAGE_TEST_MARKER();</div><div id="272" class="line none">  272         }</div><div id="273" class="line none">  273 </div><div id="274" class="line none">  274         traceMALLOC( pvReturn, xWantedSize );</div><div id="275" class="line none">  275     }</div><div id="276" class="line hit">  276     ( void ) <a href="../../include/task.h.html#1426">xTaskResumeAll</a>();</div><div id="277" class="line none">  277 </div><div id="278" class="line none">  278     #if ( configUSE_MALLOC_FAILED_HOOK == 1 )</div><div id="279" class="line none">  279     {</div><div id="280" class="line none">  280         if( pvReturn == NULL )</div><div id="281" class="line none">  281         {</div><div id="282" class="line none">  282             vApplicationMallocFailedHook();</div><div id="283" class="line none">  283         }</div><div id="284" class="line none">  284         else</div><div id="285" class="line none">  285         {</div><div id="286" class="line none">  286             mtCOVERAGE_TEST_MARKER();</div><div id="287" class="line none">  287         }</div><div id="288" class="line none">  288     }</div><div id="289" class="line none">  289     #endif /* if ( configUSE_MALLOC_FAILED_HOOK == 1 ) */</div><div id="290" class="line none">  290 </div><div id="291" class="line hit">  291     return pvReturn;</div><div id="292" class="line hit">  292 }</div><div id="293" class="line none">  293 /*-----------------------------------------------------------*/</div><div id="294" class="line none">  294 </div><div id="295" class="line none">  295 void <a href="heap_5.c.html#295">vPortFree</a>( void * pv )</div><div id="296" class="line none">  296 {</div><div id="297" class="line none">  297     uint8_t * puc = ( uint8_t * ) pv;</div><div id="298" class="line none">  298     <a href="heap_5.c.html#125">BlockLink_t</a> * pxLink;</div><div id="299" class="line none">  299 </div><div id="300" class="line none">  300     if( pv != NULL )</div><div id="301" class="line none">  301     {</div><div id="302" class="line none">  302         /* The memory being freed will have an BlockLink_t structure immediately</div><div id="303" class="line none">  303          * before it. */</div><div id="304" class="line none">  304         puc -= <a href="heap_5.c.html#141">xHeapStructSize</a>;</div><div id="305" class="line none">  305 </div><div id="306" class="line none">  306         /* This casting is to keep the compiler from issuing warnings. */</div><div id="307" class="line none">  307         pxLink = ( void * ) puc;</div><div id="308" class="line none">  308 </div><div id="309" class="line none">  309         configASSERT( <a href="heap_5.c.html#113">heapBLOCK_IS_ALLOCATED</a>( pxLink ) != 0 );</div><div id="310" class="line none">  310         configASSERT( pxLink-&gt;<a href="heap_5.c.html#123">pxNextFreeBlock</a> == NULL );</div><div id="311" class="line none">  311 </div><div id="312" class="line none">  312         if( <a href="heap_5.c.html#113">heapBLOCK_IS_ALLOCATED</a>( pxLink ) != 0 )</div><div id="313" class="line none">  313         {</div><div id="314" class="line none">  314             if( pxLink-&gt;<a href="heap_5.c.html#123">pxNextFreeBlock</a> == NULL )</div><div id="315" class="line none">  315             {</div><div id="316" class="line none">  316                 /* The block is being returned to the heap - it is no longer</div><div id="317" class="line none">  317                  * allocated. */</div><div id="318" class="line none">  318                 <a href="heap_5.c.html#115">heapFREE_BLOCK</a>( pxLink );</div><div id="319" class="line none">  319                 #if ( <a href="heap_5.c.html#89">configHEAP_CLEAR_MEMORY_ON_FREE</a> == 1 )</div><div id="320" class="line none">  320                 {</div><div id="321" class="line none">  321                     ( void ) memset( puc + <a href="heap_5.c.html#141">xHeapStructSize</a>, 0, pxLink-&gt;<a href="heap_5.c.html#124">xBlockSize</a> - <a href="heap_5.c.html#141">xHeapStructSize</a> );</div><div id="322" class="line none">  322                 }</div><div id="323" class="line none">  323                 #endif</div><div id="324" class="line none">  324 </div><div id="325" class="line none">  325                 <a href="../../include/task.h.html#1370">vTaskSuspendAll</a>();</div><div id="326" class="line none">  326                 {</div><div id="327" class="line none">  327                     /* Add this block to the list of free blocks. */</div><div id="328" class="line none">  328                     <a href="heap_5.c.html#148">xFreeBytesRemaining</a> += pxLink-&gt;<a href="heap_5.c.html#124">xBlockSize</a>;</div><div id="329" class="line none">  329                     traceFREE( pv, pxLink-&gt;<a href="heap_5.c.html#124">xBlockSize</a> );</div><div id="330" class="line none">  330                     <a href="heap_5.c.html#379">prvInsertBlockIntoFreeList</a>( ( ( <a href="heap_5.c.html#125">BlockLink_t</a> * ) pxLink ) );</div><div id="331" class="line none">  331                     <a href="heap_5.c.html#151">xNumberOfSuccessfulFrees</a>++;</div><div id="332" class="line none">  332                 }</div><div id="333" class="line none">  333                 ( void ) <a href="../../include/task.h.html#1426">xTaskResumeAll</a>();</div><div id="334" class="line none">  334             }</div><div id="335" class="line none">  335             else</div><div id="336" class="line none">  336             {</div><div id="337" class="line none">  337                 mtCOVERAGE_TEST_MARKER();</div><div id="338" class="line none">  338             }</div><div id="339" class="line none">  339         }</div><div id="340" class="line none">  340         else</div><div id="341" class="line none">  341         {</div><div id="342" class="line none">  342             mtCOVERAGE_TEST_MARKER();</div><div id="343" class="line none">  343         }</div><div id="344" class="line none">  344     }</div><div id="345" class="line none">  345 }</div><div id="346" class="line none">  346 /*-----------------------------------------------------------*/</div><div id="347" class="line none">  347 </div><div id="348" class="line none">  348 size_t <a href="heap_5.c.html#348">xPortGetFreeHeapSize</a>( void )</div><div id="349" class="line none">  349 {</div><div id="350" class="line none">  350     return <a href="heap_5.c.html#148">xFreeBytesRemaining</a>;</div><div id="351" class="line none">  351 }</div><div id="352" class="line none">  352 /*-----------------------------------------------------------*/</div><div id="353" class="line none">  353 </div><div id="354" class="line none">  354 size_t <a href="heap_5.c.html#354">xPortGetMinimumEverFreeHeapSize</a>( void )</div><div id="355" class="line none">  355 {</div><div id="356" class="line none">  356     return <a href="heap_5.c.html#149">xMinimumEverFreeBytesRemaining</a>;</div><div id="357" class="line none">  357 }</div><div id="358" class="line none">  358 /*-----------------------------------------------------------*/</div><div id="359" class="line none">  359 </div><div id="360" class="line none">  360 void * <a href="heap_5.c.html#360">pvPortCalloc</a>( size_t xNum,</div><div id="361" class="line none">  361                      size_t xSize )</div><div id="362" class="line none">  362 {</div><div id="363" class="line none">  363     void * pv = NULL;</div><div id="364" class="line none">  364 </div><div id="365" class="line none">  365     if( <a href="heap_5.c.html#102">heapMULTIPLY_WILL_OVERFLOW</a>( xNum, xSize ) == 0 )</div><div id="366" class="line none">  366     {</div><div id="367" class="line none">  367         pv = <a href="heap_5.c.html#155">pvPortMalloc</a>( xNum * xSize );</div><div id="368" class="line none">  368 </div><div id="369" class="line none">  369         if( pv != NULL )</div><div id="370" class="line none">  370         {</div><div id="371" class="line none">  371             ( void ) memset( pv, 0, xNum * xSize );</div><div id="372" class="line none">  372         }</div><div id="373" class="line none">  373     }</div><div id="374" class="line none">  374 </div><div id="375" class="line none">  375     return pv;</div><div id="376" class="line none">  376 }</div><div id="377" class="line none">  377 /*-----------------------------------------------------------*/</div><div id="378" class="line none">  378 </div><div id="379" class="line none">  379 static void <a href="heap_5.c.html#379">prvInsertBlockIntoFreeList</a>( <a href="heap_5.c.html#125">BlockLink_t</a> * pxBlockToInsert )</div><div id="380" class="line none">  380 {</div><div id="381" class="line missed">  381     <a href="heap_5.c.html#125">BlockLink_t</a> * pxIterator;</div><div id="382" class="line missed">  382     uint8_t * puc;</div><div id="383" class="line none">  383 </div><div id="384" class="line none">  384     /* Iterate through the list until a block is found that has a higher address</div><div id="385" class="line none">  385      * than the block being inserted. */</div><div id="386" class="line missed">  386     for( pxIterator = &amp;<a href="heap_5.c.html#144">xStart</a>; pxIterator-&gt;<a href="heap_5.c.html#123">pxNextFreeBlock</a> &lt; pxBlockToInsert; pxIterator = pxIterator-&gt;<a href="heap_5.c.html#123">pxNextFreeBlock</a> )</div><div id="387" class="line none">  387     {</div><div id="388" class="line none">  388         /* Nothing to do here, just iterate to the right position. */</div><div id="389" class="line none">  389     }</div><div id="390" class="line none">  390 </div><div id="391" class="line none">  391     /* Do the block being inserted, and the block it is being inserted after</div><div id="392" class="line none">  392      * make a contiguous block of memory? */</div><div id="393" class="line missed">  393     puc = ( uint8_t * ) pxIterator;</div><div id="394" class="line none">  394 </div><div id="395" class="line missed">  395     if( ( puc + pxIterator-&gt;<a href="heap_5.c.html#124">xBlockSize</a> ) == ( uint8_t * ) pxBlockToInsert )</div><div id="396" class="line none">  396     {</div><div id="397" class="line missed">  397         pxIterator-&gt;<a href="heap_5.c.html#124">xBlockSize</a> += pxBlockToInsert-&gt;<a href="heap_5.c.html#124">xBlockSize</a>;</div><div id="398" class="line missed">  398         pxBlockToInsert = pxIterator;</div><div id="399" class="line none">  399     }</div><div id="400" class="line none">  400     else</div><div id="401" class="line none">  401     {</div><div id="402" class="line none">  402         mtCOVERAGE_TEST_MARKER();</div><div id="403" class="line none">  403     }</div><div id="404" class="line none">  404 </div><div id="405" class="line none">  405     /* Do the block being inserted, and the block it is being inserted before</div><div id="406" class="line none">  406      * make a contiguous block of memory? */</div><div id="407" class="line missed">  407     puc = ( uint8_t * ) pxBlockToInsert;</div><div id="408" class="line none">  408 </div><div id="409" class="line missed">  409     if( ( puc + pxBlockToInsert-&gt;<a href="heap_5.c.html#124">xBlockSize</a> ) == ( uint8_t * ) pxIterator-&gt;<a href="heap_5.c.html#123">pxNextFreeBlock</a> )</div><div id="410" class="line none">  410     {</div><div id="411" class="line missed">  411         if( pxIterator-&gt;<a href="heap_5.c.html#123">pxNextFreeBlock</a> != <a href="heap_5.c.html#144">pxEnd</a> )</div><div id="412" class="line none">  412         {</div><div id="413" class="line none">  413             /* Form one big block from the two blocks. */</div><div id="414" class="line missed">  414             pxBlockToInsert-&gt;<a href="heap_5.c.html#124">xBlockSize</a> += pxIterator-&gt;<a href="heap_5.c.html#123">pxNextFreeBlock</a>-&gt;<a href="heap_5.c.html#124">xBlockSize</a>;</div><div id="415" class="line missed">  415             pxBlockToInsert-&gt;<a href="heap_5.c.html#123">pxNextFreeBlock</a> = pxIterator-&gt;<a href="heap_5.c.html#123">pxNextFreeBlock</a>-&gt;<a href="heap_5.c.html#123">pxNextFreeBlock</a>;</div><div id="416" class="line none">  416         }</div><div id="417" class="line none">  417         else</div><div id="418" class="line none">  418         {</div><div id="419" class="line missed">  419             pxBlockToInsert-&gt;<a href="heap_5.c.html#123">pxNextFreeBlock</a> = <a href="heap_5.c.html#144">pxEnd</a>;</div><div id="420" class="line none">  420         }</div><div id="421" class="line none">  421     }</div><div id="422" class="line none">  422     else</div><div id="423" class="line none">  423     {</div><div id="424" class="line missed">  424         pxBlockToInsert-&gt;<a href="heap_5.c.html#123">pxNextFreeBlock</a> = pxIterator-&gt;<a href="heap_5.c.html#123">pxNextFreeBlock</a>;</div><div id="425" class="line none">  425     }</div><div id="426" class="line none">  426 </div><div id="427" class="line none">  427     /* If the block being inserted plugged a gab, so was merged with the block</div><div id="428" class="line none">  428      * before and the block after, then it's pxNextFreeBlock pointer will have</div><div id="429" class="line none">  429      * already been set, and should not be set here as that would make it point</div><div id="430" class="line none">  430      * to itself. */</div><div id="431" class="line missed">  431     if( pxIterator != pxBlockToInsert )</div><div id="432" class="line none">  432     {</div><div id="433" class="line missed">  433         pxIterator-&gt;<a href="heap_5.c.html#123">pxNextFreeBlock</a> = pxBlockToInsert;</div><div id="434" class="line none">  434     }</div><div id="435" class="line none">  435     else</div><div id="436" class="line none">  436     {</div><div id="437" class="line none">  437         mtCOVERAGE_TEST_MARKER();</div><div id="438" class="line none">  438     }</div><div id="439" class="line missed">  439 }</div><div id="440" class="line none">  440 /*-----------------------------------------------------------*/</div><div id="441" class="line none">  441 </div><div id="442" class="line none">  442 void <a href="heap_5.c.html#442">vPortDefineHeapRegions</a>( const <a href="../../include/portable.h.html#139">HeapRegion_t</a> * const pxHeapRegions )</div><div id="443" class="line none">  443 {</div><div id="444" class="line none">  444     <a href="heap_5.c.html#125">BlockLink_t</a> * pxFirstFreeBlockInRegion = NULL, * pxPreviousFreeBlock;</div><div id="445" class="line none">  445     size_t xAlignedHeap;</div><div id="446" class="line none">  446     size_t xTotalRegionSize, xTotalHeapSize = 0;</div><div id="447" class="line none">  447     <a href="../ThirdParty/GCC/Posix/portmacro.h.html#60">BaseType_t</a> xDefinedRegions = 0;</div><div id="448" class="line none">  448     size_t xAddress;</div><div id="449" class="line none">  449     const <a href="../../include/portable.h.html#139">HeapRegion_t</a> * pxHeapRegion;</div><div id="450" class="line none">  450 </div><div id="451" class="line none">  451     /* Can only call once! */</div><div id="452" class="line none">  452     configASSERT( <a href="heap_5.c.html#144">pxEnd</a> == NULL );</div><div id="453" class="line none">  453 </div><div id="454" class="line none">  454     pxHeapRegion = &amp;( pxHeapRegions[ xDefinedRegions ] );</div><div id="455" class="line none">  455 </div><div id="456" class="line none">  456     while( pxHeapRegion-&gt;<a href="../../include/portable.h.html#138">xSizeInBytes</a> &gt; 0 )</div><div id="457" class="line none">  457     {</div><div id="458" class="line none">  458         xTotalRegionSize = pxHeapRegion-&gt;<a href="../../include/portable.h.html#138">xSizeInBytes</a>;</div><div id="459" class="line none">  459 </div><div id="460" class="line none">  460         /* Ensure the heap region starts on a correctly aligned boundary. */</div><div id="461" class="line none">  461         xAddress = ( size_t ) pxHeapRegion-&gt;<a href="../../include/portable.h.html#137">pucStartAddress</a>;</div><div id="462" class="line none">  462 </div><div id="463" class="line none">  463         if( ( xAddress &amp; <a href="../../include/portable.h.html#57">portBYTE_ALIGNMENT_MASK</a> ) != 0 )</div><div id="464" class="line none">  464         {</div><div id="465" class="line none">  465             xAddress += ( <a href="../ThirdParty/GCC/Posix/portmacro.h.html#75">portBYTE_ALIGNMENT</a> - 1 );</div><div id="466" class="line none">  466             xAddress &amp;= ~<a href="../../include/portable.h.html#57">portBYTE_ALIGNMENT_MASK</a>;</div><div id="467" class="line none">  467 </div><div id="468" class="line none">  468             /* Adjust the size for the bytes lost to alignment. */</div><div id="469" class="line none">  469             xTotalRegionSize -= xAddress - ( size_t ) pxHeapRegion-&gt;<a href="../../include/portable.h.html#137">pucStartAddress</a>;</div><div id="470" class="line none">  470         }</div><div id="471" class="line none">  471 </div><div id="472" class="line none">  472         xAlignedHeap = xAddress;</div><div id="473" class="line none">  473 </div><div id="474" class="line none">  474         /* Set xStart if it has not already been set. */</div><div id="475" class="line none">  475         if( xDefinedRegions == 0 )</div><div id="476" class="line none">  476         {</div><div id="477" class="line none">  477             /* xStart is used to hold a pointer to the first item in the list of</div><div id="478" class="line none">  478              *  free blocks.  The void cast is used to prevent compiler warnings. */</div><div id="479" class="line none">  479             <a href="heap_5.c.html#144">xStart</a>.<a href="heap_5.c.html#123">pxNextFreeBlock</a> = ( <a href="heap_5.c.html#125">BlockLink_t</a> * ) xAlignedHeap;</div><div id="480" class="line none">  480             <a href="heap_5.c.html#144">xStart</a>.<a href="heap_5.c.html#124">xBlockSize</a> = ( size_t ) 0;</div><div id="481" class="line none">  481         }</div><div id="482" class="line none">  482         else</div><div id="483" class="line none">  483         {</div><div id="484" class="line none">  484             /* Should only get here if one region has already been added to the</div><div id="485" class="line none">  485              * heap. */</div><div id="486" class="line none">  486             configASSERT( <a href="heap_5.c.html#144">pxEnd</a> != NULL );</div><div id="487" class="line none">  487 </div><div id="488" class="line none">  488             /* Check blocks are passed in with increasing start addresses. */</div><div id="489" class="line none">  489             configASSERT( xAddress &gt; ( size_t ) <a href="heap_5.c.html#144">pxEnd</a> );</div><div id="490" class="line none">  490         }</div><div id="491" class="line none">  491 </div><div id="492" class="line none">  492         /* Remember the location of the end marker in the previous region, if</div><div id="493" class="line none">  493          * any. */</div><div id="494" class="line none">  494         pxPreviousFreeBlock = <a href="heap_5.c.html#144">pxEnd</a>;</div><div id="495" class="line none">  495 </div><div id="496" class="line none">  496         /* pxEnd is used to mark the end of the list of free blocks and is</div><div id="497" class="line none">  497          * inserted at the end of the region space. */</div><div id="498" class="line none">  498         xAddress = xAlignedHeap + xTotalRegionSize;</div><div id="499" class="line none">  499         xAddress -= <a href="heap_5.c.html#141">xHeapStructSize</a>;</div><div id="500" class="line none">  500         xAddress &amp;= ~( ( size_t ) <a href="../../include/portable.h.html#57">portBYTE_ALIGNMENT_MASK</a> );</div><div id="501" class="line none">  501         <a href="heap_5.c.html#144">pxEnd</a> = ( <a href="heap_5.c.html#125">BlockLink_t</a> * ) xAddress;</div><div id="502" class="line none">  502         <a href="heap_5.c.html#144">pxEnd</a>-&gt;<a href="heap_5.c.html#124">xBlockSize</a> = 0;</div><div id="503" class="line none">  503         <a href="heap_5.c.html#144">pxEnd</a>-&gt;<a href="heap_5.c.html#123">pxNextFreeBlock</a> = NULL;</div><div id="504" class="line none">  504 </div><div id="505" class="line none">  505         /* To start with there is a single free block in this region that is</div><div id="506" class="line none">  506          * sized to take up the entire heap region minus the space taken by the</div><div id="507" class="line none">  507          * free block structure. */</div><div id="508" class="line none">  508         pxFirstFreeBlockInRegion = ( <a href="heap_5.c.html#125">BlockLink_t</a> * ) xAlignedHeap;</div><div id="509" class="line none">  509         pxFirstFreeBlockInRegion-&gt;<a href="heap_5.c.html#124">xBlockSize</a> = xAddress - ( size_t ) pxFirstFreeBlockInRegion;</div><div id="510" class="line none">  510         pxFirstFreeBlockInRegion-&gt;<a href="heap_5.c.html#123">pxNextFreeBlock</a> = <a href="heap_5.c.html#144">pxEnd</a>;</div><div id="511" class="line none">  511 </div><div id="512" class="line none">  512         /* If this is not the first region that makes up the entire heap space</div><div id="513" class="line none">  513          * then link the previous region to this region. */</div><div id="514" class="line none">  514         if( pxPreviousFreeBlock != NULL )</div><div id="515" class="line none">  515         {</div><div id="516" class="line none">  516             pxPreviousFreeBlock-&gt;<a href="heap_5.c.html#123">pxNextFreeBlock</a> = pxFirstFreeBlockInRegion;</div><div id="517" class="line none">  517         }</div><div id="518" class="line none">  518 </div><div id="519" class="line none">  519         xTotalHeapSize += pxFirstFreeBlockInRegion-&gt;<a href="heap_5.c.html#124">xBlockSize</a>;</div><div id="520" class="line none">  520 </div><div id="521" class="line none">  521         /* Move onto the next HeapRegion_t structure. */</div><div id="522" class="line none">  522         xDefinedRegions++;</div><div id="523" class="line none">  523         pxHeapRegion = &amp;( pxHeapRegions[ xDefinedRegions ] );</div><div id="524" class="line none">  524     }</div><div id="525" class="line none">  525 </div><div id="526" class="line none">  526     <a href="heap_5.c.html#149">xMinimumEverFreeBytesRemaining</a> = xTotalHeapSize;</div><div id="527" class="line none">  527     <a href="heap_5.c.html#148">xFreeBytesRemaining</a> = xTotalHeapSize;</div><div id="528" class="line none">  528 </div><div id="529" class="line none">  529     /* Check something was actually defined before it is accessed. */</div><div id="530" class="line none">  530     configASSERT( xTotalHeapSize );</div><div id="531" class="line none">  531 }</div><div id="532" class="line none">  532 /*-----------------------------------------------------------*/</div><div id="533" class="line none">  533 </div><div id="534" class="line none">  534 void <a href="heap_5.c.html#534">vPortGetHeapStats</a>( <a href="../../include/portable.h.html#151">HeapStats_t</a> * pxHeapStats )</div><div id="535" class="line none">  535 {</div><div id="536" class="line none">  536     <a href="heap_5.c.html#125">BlockLink_t</a> * pxBlock;</div><div id="537" class="line none">  537     size_t xBlocks = 0, xMaxSize = 0, xMinSize = <a href="../ThirdParty/GCC/Posix/portmacro.h.html#64">portMAX_DELAY</a>; /* portMAX_DELAY used as a portable way of getting the maximum value. */</div><div id="538" class="line none">  538 </div><div id="539" class="line none">  539     <a href="../../include/task.h.html#1370">vTaskSuspendAll</a>();</div><div id="540" class="line none">  540     {</div><div id="541" class="line none">  541         pxBlock = <a href="heap_5.c.html#144">xStart</a>.<a href="heap_5.c.html#123">pxNextFreeBlock</a>;</div><div id="542" class="line none">  542 </div><div id="543" class="line none">  543         /* pxBlock will be NULL if the heap has not been initialised.  The heap</div><div id="544" class="line none">  544          * is initialised automatically when the first allocation is made. */</div><div id="545" class="line none">  545         if( pxBlock != NULL )</div><div id="546" class="line none">  546         {</div><div id="547" class="line none">  547             do</div><div id="548" class="line none">  548             {</div><div id="549" class="line none">  549                 /* Increment the number of blocks and record the largest block seen</div><div id="550" class="line none">  550                  * so far. */</div><div id="551" class="line none">  551                 xBlocks++;</div><div id="552" class="line none">  552 </div><div id="553" class="line none">  553                 if( pxBlock-&gt;<a href="heap_5.c.html#124">xBlockSize</a> &gt; xMaxSize )</div><div id="554" class="line none">  554                 {</div><div id="555" class="line none">  555                     xMaxSize = pxBlock-&gt;<a href="heap_5.c.html#124">xBlockSize</a>;</div><div id="556" class="line none">  556                 }</div><div id="557" class="line none">  557 </div><div id="558" class="line none">  558                 /* Heap five will have a zero sized block at the end of each</div><div id="559" class="line none">  559                  * each region - the block is only used to link to the next</div><div id="560" class="line none">  560                  * heap region so it not a real block. */</div><div id="561" class="line none">  561                 if( pxBlock-&gt;<a href="heap_5.c.html#124">xBlockSize</a> != 0 )</div><div id="562" class="line none">  562                 {</div><div id="563" class="line none">  563                     if( pxBlock-&gt;<a href="heap_5.c.html#124">xBlockSize</a> &lt; xMinSize )</div><div id="564" class="line none">  564                     {</div><div id="565" class="line none">  565                         xMinSize = pxBlock-&gt;<a href="heap_5.c.html#124">xBlockSize</a>;</div><div id="566" class="line none">  566                     }</div><div id="567" class="line none">  567                 }</div><div id="568" class="line none">  568 </div><div id="569" class="line none">  569                 /* Move to the next block in the chain until the last block is</div><div id="570" class="line none">  570                  * reached. */</div><div id="571" class="line none">  571                 pxBlock = pxBlock-&gt;<a href="heap_5.c.html#123">pxNextFreeBlock</a>;</div><div id="572" class="line none">  572             } while( pxBlock != <a href="heap_5.c.html#144">pxEnd</a> );</div><div id="573" class="line none">  573         }</div><div id="574" class="line none">  574     }</div><div id="575" class="line none">  575     ( void ) <a href="../../include/task.h.html#1426">xTaskResumeAll</a>();</div><div id="576" class="line none">  576 </div><div id="577" class="line none">  577     pxHeapStats-&gt;<a href="../../include/portable.h.html#145">xSizeOfLargestFreeBlockInBytes</a> = xMaxSize;</div><div id="578" class="line none">  578     pxHeapStats-&gt;<a href="../../include/portable.h.html#146">xSizeOfSmallestFreeBlockInBytes</a> = xMinSize;</div><div id="579" class="line none">  579     pxHeapStats-&gt;<a href="../../include/portable.h.html#147">xNumberOfFreeBlocks</a> = xBlocks;</div><div id="580" class="line none">  580 </div><div id="581" class="line none">  581     <a href="../../include/task.h.html#210">taskENTER_CRITICAL</a>();</div><div id="582" class="line none">  582     {</div><div id="583" class="line none">  583         pxHeapStats-&gt;<a href="../../include/portable.h.html#144">xAvailableHeapSpaceInBytes</a> = <a href="heap_5.c.html#148">xFreeBytesRemaining</a>;</div><div id="584" class="line none">  584         pxHeapStats-&gt;<a href="heap_5.c.html#150">xNumberOfSuccessfulAllocations</a> = <a href="heap_5.c.html#150">xNumberOfSuccessfulAllocations</a>;</div><div id="585" class="line none">  585         pxHeapStats-&gt;<a href="heap_5.c.html#151">xNumberOfSuccessfulFrees</a> = <a href="heap_5.c.html#151">xNumberOfSuccessfulFrees</a>;</div><div id="586" class="line none">  586         pxHeapStats-&gt;<a href="heap_5.c.html#149">xMinimumEverFreeBytesRemaining</a> = <a href="heap_5.c.html#149">xMinimumEverFreeBytesRemaining</a>;</div><div id="587" class="line none">  587     }</div><div id="588" class="line none">  588     <a href="../../include/task.h.html#225">taskEXIT_CRITICAL</a>();</div><div id="589" class="line none">  589 }</div><div id="590" class="line none">  590 /*-----------------------------------------------------------*/</div>
</div>
</body>
</html>
